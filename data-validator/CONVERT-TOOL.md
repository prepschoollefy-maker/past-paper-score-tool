# PDF→XLSX 変換ツール 仕組み解説

## 概要

四谷大塚の入試結果一覧PDF（表形式）を、ブラウザ上でAI-OCRにかけて構造化データ（XLSX）に変換するツール。

URL: https://data-validator-mu.vercel.app/convert

## データフロー

```
 ブラウザ                            サーバー (Vercel)
┌─────────────────────┐
│ 1. PDFファイル選択    │
│    ↓                 │
│ 2. pdfjs-dist で     │
│    ページ→画像変換    │
│    (300dpi Canvas)   │
│    ↓                 │
│ 3. 画像を短冊切り     │
│    (800px高,          │
│     150px重複)        │
│    ↓ base64 PNG      │
│    ─────────────────────→  4. Claude Vision API
│                      │       画像→JSON抽出
│    ←─────────────────────  (学校名,配点,平均点...)
│    ↓                 │
│ 5. 全短冊の結果を     │
│    重複排除・結合      │
│    ↓                 │
│ 6. テーブル表示       │
│    + XLSXダウンロード │
└─────────────────────┘
```

## なぜ「短冊切り」するのか

PDFを丸ごと1ページ送ると:
- 画像が大きすぎてAPI制限に引っかかる
- 情報量が多すぎて読み取り精度が下がる
- Vercelの60秒タイムアウトに引っかかる

そこで1ページを約7枚の「短冊」に分割し、1枚ずつAPIに送る。
隣接する短冊は150px重なるので、行の切れ目で情報が失われない。

```
ページ画像 (約4300px高)
┌──────────────┐
│  短冊1 800px  │
│        ───── │ ← 150px重複
│  短冊2 800px  │
│        ───── │ ← 150px重複
│  短冊3 800px  │
│    ...       │
│  短冊7 残り   │
└──────────────┘
```

## PDFの表構造

元のPDFは各学校×試験回ごとに **3行1セット** で構成されている:

| 学校名     | 回  | 国語  | 算数  | ... | 合計    |
|-----------|-----|------|------|-----|---------|
| ○○中学校  | 1回 | 100  | 100  |     | 300     | ← **配点**（満点）
|           |     | 72.5 | 68.3 |     | 216.1   | ← **合格者平均点**
|           |     | 65.8 | 55.2 |     | 186.7   | ← **受験者平均点**

Claude Vision がこの3行を読み取り、1つのJSONオブジェクトに統合する。

## 重複排除（マージ）のしくみ

短冊の重なり部分で同じ学校が2回抽出されることがある。
これを防ぐため、マージ処理で:

1. **学校名を正規化**して比較（スペース除去、「中学校」除去、NFKC正規化）
2. 新しい行を追加する前に、直近10行と学校名+回が一致するか確認
3. 重複があれば **confidence（確信度）が高い方のセル値** を採用

## 出力（XLSX）

ExcelJSで3シート構成のXLSXを生成:

| シート | 内容 |
|--------|------|
| 抽出データ | 25列の構造化データ。confidence低のセルは色付き |
| 品質レポート | medium/low confidenceのセル一覧 |
| Warnings | AIが出した警告メッセージ一覧 |

### 25列の内訳

```
学校名 / 別名（略称）/ 年度 / 回
国語配点 / 算数配点 / 社会配点 / 理科配点 / 英語配点
国語合格者平均点 / 国語受験者平均点
算数合格者平均点 / 算数受験者平均点
社会合格者平均点 / 社会受験者平均点
理科合格者平均点 / 理科受験者平均点
英語合格者平均点 / 英語受験者平均点
総合合格者最低点 / 総合合格者最低点※2 / 総合合格最高点
総合合格者平均点 / 総合受験者平均点
備考
```

## ファイル構成

```
src/
  app/
    convert/page.tsx              ← /convert ページ
    api/ocr-strip/route.ts        ← 短冊1枚→Claude Vision API
  components/
    PdfConverter.tsx               ← メインUI（アップロード→処理→結果）
    NavTabs.tsx                    ← ページ切替タブ
  lib/
    pdfRenderer.ts                 ← PDF→Canvas→短冊切り (pdfjs-dist)
    stripMerger.ts                 ← 重複排除・結合ロジック
    converterExport.ts             ← XLSX出力 (ExcelJS)
```

## 処理の分担

| 処理 | 実行場所 | 理由 |
|------|----------|------|
| PDF→画像変換 | ブラウザ | サーバーにPDFライブラリ不要 |
| 短冊切り | ブラウザ | Canvas APIで高速 |
| AI OCR | サーバー | APIキーをサーバーに保持 |
| マージ・重複排除 | ブラウザ | サーバー負荷軽減 |
| XLSX生成 | ブラウザ | ExcelJSはクライアントで動作 |
